import json
from datetime import datetime
from telegram import InlineKeyboardButton, InlineKeyboardMarkup
from telegram.constants import ParseMode
from telegram.error import BadRequest

from helpers import check_admin_permissions, truncate_text, format_date, format_welcome_message
from config import logger


class CallbackHandlers:
    def __init__(self, db_manager, message_handler):
        self.db = db_manager
        self.message_handler = message_handler

    def _is_public_callback(self, data: str) -> bool:
        """Verifica si es un callback p√∫blico (navegaci√≥n de bienvenida)"""
        return data.startswith("wb_") or data.startswith("wb_home_")

    async def safe_edit_message_text(self, query, text: str, reply_markup=None, parse_mode=None):
        """Edita mensaje de texto de forma segura"""
        try:
            await query.edit_message_text(text, reply_markup=reply_markup, parse_mode=parse_mode)
        except BadRequest as e:
            msg = str(e).lower()
            if "message is not modified" in msg:
                try:
                    await query.answer("‚úÖ Contenido ya actualizado")
                except:
                    pass
            elif "can't parse entities" in msg:
                try:
                    await query.edit_message_text(text, reply_markup=reply_markup, parse_mode=None)
                    return
                except:
                    pass
                raise
            else:
                raise

    async def safe_edit_message_caption(self, query, caption: str, reply_markup=None, parse_mode=None):
        """Edita caption de mensaje de forma segura"""
        try:
            await query.edit_message_caption(caption=caption, reply_markup=reply_markup, parse_mode=parse_mode)
        except BadRequest as e:
            msg = str(e).lower()
            if "message is not modified" in msg:
                try:
                    await query.answer("‚úÖ Contenido ya actualizado")
                except:
                    pass
            elif "can't parse entities" in msg:
                try:
                    await query.edit_message_caption(caption=caption, reply_markup=reply_markup, parse_mode=None)
                    return
                except:
                    pass
                raise
            else:
                raise

    def _normalize_parse_mode(self, pm: str | None) -> str:
        """Normaliza el modo de parseo"""
        if not pm:
            return "HTML"
        if pm.lower().startswith("markdown"):
            return "MarkdownV2"
        return "HTML" if pm.upper() == "HTML" else pm

    def _buttons_to_list(self, buttons):
        """Normaliza botones a lista de listas"""
        if not buttons:
            return []
        if isinstance(buttons, str):
            try:
                parsed = json.loads(buttons)
                return parsed if isinstance(parsed, list) else []
            except Exception:
                return []
        if isinstance(buttons, list):
            return buttons
        return []

    async def handle_callback_query(self, update, context):
        """Maneja todas las consultas de callback"""
        query = update.callback_query
        await query.answer()
        data = query.data
        user_id = query.from_user.id

        logger.info(f"üîò Callback recibido: {data} de usuario {user_id}")

        # Verificar permisos para callbacks no p√∫blicos
        if not self._is_public_callback(data):
            if not check_admin_permissions(user_id, data):
                await self.safe_edit_message_text(
                    query, 
                    "‚ùå **Acceso Denegado**\n\nNo tienes permisos para realizar esta acci√≥n.",
                    parse_mode=ParseMode.MARKDOWN
                )
                return

        # Navegaci√≥n p√∫blica (sistema de bienvenida)
        if data.startswith("wb_home_"):
            chat_id = int(data.split("_")[-1])
            node = await self.db.get_root_node(chat_id)
            await self.show_node_content(query, node, book_mode=True)
            return
            
        if data.startswith("wb_") and len(data.split("_")) == 2 and data.split("_")[1].isdigit():
            node_id = int(data.split("_")[1])
            node = await self.db.get_node(node_id)
            if node:
                await self.show_node_content(query, node, book_mode=True)
            else:
                await query.answer("‚ùå Contenido no disponible", show_alert=True)
            return

        # Routing de administraci√≥n
        await self._handle_admin_callbacks(query, data)

    async def _handle_admin_callbacks(self, query, data):
        """Maneja callbacks de administraci√≥n"""
        if data == "admin_panel":
            await self.show_admin_panel(query)
        elif data == "view_groups":
            await self.show_groups_list(query)
        elif data == "bot_info":
            await self.show_bot_info(query)
        elif data == "manage_welcomes":
            await self.show_manage_welcomes(query)
        elif data == "global_settings":
            await self.show_global_settings(query)
        elif data == "general_stats":
            await self.show_general_stats(query)
        elif data.startswith("config_welcome_"):
            chat_id = int(data.split("_")[-1])
            await self.show_welcome_config(query, chat_id)
        elif data.startswith("group_settings_"):
            chat_id = int(data.split("_")[-1])
            await self.show_group_settings(query, chat_id)
        elif data.startswith("group_stats_"):
            chat_id = int(data.split("_")[-1])
            await self.show_group_stats(query, chat_id)
        elif data.startswith("config_group_"):
            chat_id = int(data.split("_")[-1])
            await self.show_group_config(query, chat_id)
        elif data.startswith("test_welcome_"):
            chat_id = int(data.split("_")[-1])
            await self.test_welcome_message(query, chat_id)
        else:
            await self._handle_specific_callbacks(query, data)

    async def _handle_specific_callbacks(self, query, data):
        """Maneja callbacks espec√≠ficos"""
        if data.startswith("edit_welcome_buttons_"):
            chat_id = int(data.split("_")[-1])
            await self.show_node_manager(query, chat_id, None)
        elif data.startswith("node_mgr_"):
            parts = data.split("_")
            node_id = int(parts[-1])
            chat_id = int(parts[-2])
            await self.show_node_manager(query, chat_id, node_id)
        elif data.startswith("node_add_url_"):
            node_id = int(data.split("_")[-1])
            await self.start_add_url_button(query, node_id)
        elif data.startswith("node_add_sub_"):
            node_id = int(data.split("_")[-1])
            await self.start_add_submenu_button(query, node_id)
        elif data.startswith("edit_welcome_message_"):
            chat_id = int(data.split("_")[-1])
            await self.start_welcome_message_edit(query, chat_id)
        elif data.startswith("toggle_welcome_"):
            chat_id = int(data.split("_")[-1])
            await self.toggle_welcome_status(query, chat_id)
        elif data.startswith("welcome_mode_"):
            await self._handle_welcome_mode_callback(query, data)
        elif data.startswith("back_"):
            await self.handle_back_navigation(query, data)

    async def _handle_welcome_mode_callback(self, query, data):
        """Maneja callback de modo de bienvenida"""
        parts = data.split("_")
        if len(parts) >= 4:
            chat_id = int(parts[2])
            mode = "_".join(parts[3:])
            await self.set_welcome_mode(query, chat_id, mode)

    def build_node_keyboard(self, node: dict):
        """Construye teclado para un nodo"""
        rows = []
        buttons = self._buttons_to_list(node.get('buttons'))

        for row in buttons:
            rb = []
            for b in row:
                if b.get('type') == 'url' and b.get('url'):
                    rb.append(InlineKeyboardButton(b.get('text', 'Abrir'), url=b['url']))
                elif b.get('type') == 'node' and b.get('node_id'):
                    rb.append(InlineKeyboardButton(b.get('text', 'Ver'), callback_data=f"wb_{b['node_id']}"))
            if rb:
                rows.append(rb)

        # Botones de navegaci√≥n
        if node.get('parent_id'):
            rows.append([
                InlineKeyboardButton("‚óÄÔ∏è Atr√°s", callback_data=f"wb_{node['parent_id']}"),
                InlineKeyboardButton("üè† Inicio", callback_data=f"wb_home_{node['chat_id']}")
            ])
        elif rows:
            rows.append([InlineKeyboardButton("üè† Inicio", callback_data=f"wb_home_{node['chat_id']}")])

        return InlineKeyboardMarkup(rows) if rows else None

    async def show_node_content(self, query, node: dict, book_mode: bool = True):
        """Muestra contenido de un nodo"""
        if not node:
            await query.answer("‚ùå Contenido no disponible", show_alert=True)
            return
            
        try:
            group_info = await self.db.get_group_info(node['chat_id'])
            group_name = group_info[1] if group_info else "el grupo"
            pmode = self._normalize_parse_mode(node.get('parse_mode') or "HTML")
            text = format_welcome_message(node['text'] or "", query.from_user, group_name, parse_mode=pmode)
            km = self.build_node_keyboard(node)

            message = query.message
            has_image = bool(node.get('image_url'))
            is_message_photo = bool(getattr(message, "photo", None))

            if has_image:
                if is_message_photo:
                    await self.safe_edit_message_caption(query, text, reply_markup=km, parse_mode=pmode)
                else:
                    current_chat_id = message.chat.id if message and message.chat else node['chat_id']
                    current_thread_id = getattr(message, "message_thread_id", None) if message else None
                    
                    await query.bot.send_photo(
                        chat_id=current_chat_id,
                        photo=node['image_url'],
                        caption=text,
                        reply_markup=km,
                        parse_mode=pmode,
                        message_thread_id=current_thread_id
                    )
            else:
                if is_message_photo:
                    current_chat_id = message.chat.id if message and message.chat else node['chat_id']
                    current_thread_id = getattr(message, "message_thread_id", None) if message else None
                    
                    await query.bot.send_message(
                        chat_id=current_chat_id,
                        text=text,
                        reply_markup=km,
                        parse_mode=pmode,
                        message_thread_id=current_thread_id
                    )
                else:
                    await self.safe_edit_message_text(query, text, reply_markup=km, parse_mode=pmode)

        except BadRequest as e:
            if "can't parse entities" in str(e).lower():
                # Reintento sin formato
                safe_text = format_welcome_message(node['text'] or "", query.from_user, group_name, parse_mode=None)
                try:
                    if has_image and not is_message_photo:
                        await query.bot.send_photo(
                            chat_id=current_chat_id,
                            photo=node['image_url'],
                            caption=safe_text,
                            reply_markup=km,
                            parse_mode=None,
                            message_thread_id=current_thread_id
                        )
                    else:
                        await self.safe_edit_message_text(query, safe_text, reply_markup=km, parse_mode=None)
                except Exception as e2:
                    logger.error(f"‚ùå Error mostrando contenido sin formato: {e2}")
            else:
                logger.error(f"‚ùå Error mostrando contenido: {e}")
        except Exception as e:
            logger.error(f"‚ùå Error inesperado mostrando contenido: {e}")
            try:
                await query.answer(f"‚ùå Error mostrando contenido", show_alert=True)
            except:
                pass

    async def test_welcome_message(self, query, chat_id: int):
        """CORREGIDO: Env√≠a una vista previa funcional del mensaje de bienvenida"""
        logger.info(f"üß™ Iniciando prueba de bienvenida para grupo {chat_id}")
        
        try:
            # Asegurar que existe el nodo ra√≠z
            await self.db.ensure_root_node(chat_id)
            root = await self.db.get_root_node(chat_id)
            if not root:
                await query.answer("‚ùå No hay configuraci√≥n de bienvenida", show_alert=True)
                return

            # Obtener informaci√≥n del grupo
            group = await self.db.get_group_info(chat_id)
            group_name = group[1] if group else "el grupo de prueba"
            
            # Preparar datos del mensaje
            pmode = self._normalize_parse_mode(root.get("parse_mode") or "HTML")
            text = format_welcome_message(
                root.get("text") or "",
                query.from_user,
                group_name,
                parse_mode=pmode
            )
            keyboard = self.build_node_keyboard(root)
            admin_chat_id = query.from_user.id

            # Texto de vista previa
            preview_header = f"üß™ **Vista previa de bienvenida**\nüìç **Grupo:** {group_name}\n\n"
            
            logger.info(f"üì§ Enviando vista previa a chat privado {admin_chat_id}")

            # Enviar la vista previa
            if root.get("image_url"):
                # Con imagen
                full_caption = preview_header + text
                await query.bot.send_photo(
                    chat_id=admin_chat_id,
                    photo=root["image_url"],
                    caption=full_caption,
                    reply_markup=keyboard,
                    parse_mode=pmode
                )
                logger.info("üì∑ Vista previa con imagen enviada")
            else:
                # Solo texto
                full_text = preview_header + text
                await query.bot.send_message(
                    chat_id=admin_chat_id,
                    text=full_text,
                    reply_markup=keyboard,
                    parse_mode=pmode
                )
                logger.info("üìù Vista previa de texto enviada")
            
            await query.answer("‚úÖ Vista previa enviada a tu chat privado")
            logger.info("‚úÖ Prueba de bienvenida completada exitosamente")

        except BadRequest as e:
            # Fallback si hay error de parseo
            if "can't parse entities" in str(e).lower():
                logger.warning(f"‚ö†Ô∏è Error de parseo, enviando sin formato: {e}")
                try:
                    safe_text = f"üß™ Vista previa de bienvenida\nüìç Grupo: {group_name}\n\n"
                    safe_text += format_welcome_message(
                        root.get("text") or "",
                        query.from_user,
                        group_name,
                        parse_mode=None
                    )
                    
                    if root.get("image_url"):
                        await query.bot.send_photo(
                            chat_id=admin_chat_id,
                            photo=root["image_url"],
                            caption=safe_text,
                            reply_markup=keyboard,
                            parse_mode=None
                        )
                    else:
                        await query.bot.send_message(
                            chat_id=admin_chat_id,
                            text=safe_text,
                            reply_markup=keyboard,
                            parse_mode=None
                        )
                    await query.answer("‚úÖ Vista previa enviada (sin formato)")
                    logger.info("‚úÖ Vista previa sin formato enviada")
                except Exception as e2:
                    logger.error(f"‚ùå Error enviando vista previa sin formato: {e2}")
                    await query.answer("‚ùå Error enviando vista previa", show_alert=True)
            else:
                logger.error(f"‚ùå Error BadRequest en vista previa: {e}")
                await query.answer("‚ùå Error enviando vista previa", show_alert=True)
        except Exception as e:
            logger.error(f"‚ùå Error inesperado en prueba de bienvenida: {e}")
            await query.answer("‚ùå Error inesperado. Revisa los logs.", show_alert=True)

    async def set_welcome_mode(self, query, chat_id: int, mode: str):
        """Establece el modo de bienvenida"""
        await self.db.set_welcome_mode(chat_id, mode)
        mode_text = "siempre" if mode == "always" else "solo nuevos usuarios"
        await query.answer(f"‚úÖ Modo actualizado: {mode_text}")
        await self.show_welcome_config(query, chat_id)

    async def show_admin_panel(self, query):
        """Muestra el panel principal de administraci√≥n"""
        keyboard = [
            [InlineKeyboardButton("üìä Ver Grupos", callback_data="view_groups")],
            [InlineKeyboardButton("üéâ Gestionar Bienvenidas", callback_data="manage_welcomes")],
            [InlineKeyboardButton("‚öôÔ∏è Configuraciones Globales", callback_data="global_settings")],
            [InlineKeyboardButton("üìà Estad√≠sticas Generales", callback_data="general_stats")],
            [InlineKeyboardButton("‚ÑπÔ∏è Informaci√≥n del Bot", callback_data="bot_info")]
        ]
        
        text = (
            "üè† **Panel de Administraci√≥n Principal**\n\n"
            "Bienvenido al sistema de control del bot administrador.\n\n"
            "**Funciones disponibles:**\n"
            "‚Ä¢ Gesti√≥n completa de grupos\n"
            "‚Ä¢ Sistema de bienvenidas avanzado\n"
            "‚Ä¢ Configuraci√≥n global del bot\n"
            "‚Ä¢ Estad√≠sticas detalladas\n"
            "‚Ä¢ Monitoreo en tiempo real\n\n"
            "Selecciona una opci√≥n para continuar:"
        )
        
        await self.safe_edit_message_text(
            query,
            text,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode=ParseMode.MARKDOWN
        )

    async def show_groups_list(self, query):
        """Muestra la lista de grupos registrados"""
        groups = await self.db.get_all_active_groups()
        if not groups:
            await self.safe_edit_message_text(
                query,
                "üì≠ **No hay grupos registrados**\n\n"
                "A√±ade el bot a un grupo para comenzar a administrarlo.\n\n"
                "**Instrucciones:**\n"
                "1. A√±ade el bot a tu grupo\n"
                "2. Dale permisos de administrador\n"
                "3. Usa `/admin` para configurar",
                reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("üîô Volver", callback_data="admin_panel")]]),
                parse_mode=ParseMode.MARKDOWN
            )
            return

        text = "üìä **Lista de Grupos Registrados**\n\n"
        keyboard = []
        
        for i, group in enumerate(groups, 1):
            text += f"**{i}. {group[1]}**\n"
            text += f"   üÜî ID: `{group[0]}`\n"
            text += f"   üë• Miembros: {group[6]}\n"
            text += f"   üìÖ A√±adido: {format_date(group[7])}\n"
            text += f"   üí¨ Foro: {'‚úÖ' if group[9] else '‚ùå'}\n\n"
            
            keyboard.append([InlineKeyboardButton(
                f"‚öôÔ∏è {truncate_text(group[1], 25)}",
                callback_data=f"config_group_{group[0]}"
            )])

        keyboard.append([InlineKeyboardButton("üîô Volver al Panel", callback_data="admin_panel")])
        
        await self.safe_edit_message_text(
            query, 
            text, 
            reply_markup=InlineKeyboardMarkup(keyboard), 
            parse_mode=ParseMode.MARKDOWN
        )

    async def show_welcome_config(self, query, chat_id: int):
        """Muestra configuraci√≥n de bienvenida de un grupo"""
        await self.db.ensure_root_node(chat_id)
        welcome_config = await self.db.get_welcome_settings(chat_id)
        group = await self.db.get_group_info(chat_id)
        
        if not group:
            await self.safe_edit_message_text(query, "‚ùå Grupo no encontrado.")
            return

        root_node = await self.db.get_root_node(chat_id)
        buttons = self._buttons_to_list(root_node.get('buttons') if root_node else [])
        buttons_count = sum(len(r) for r in buttons)
        welcome_mode = await self.db.get_welcome_mode(chat_id)

        status = "‚úÖ Activado" if welcome_config and welcome_config[1] else "‚ùå Desactivado"
        message_preview = truncate_text(root_node['text'] or "", 120) if root_node else "Sin mensaje"
        mode_text = "Siempre" if welcome_mode == "always" else "Solo nuevos usuarios"

        text = (
            f"üéâ **Configuraci√≥n de Bienvenida**\n\n"
            f"**Grupo:** {group[1]}\n"
            f"**Estado:** {status}\n"
            f"**Modo:** {mode_text}\n"
            f"**Botones:** {buttons_count} configurados\n"
            f"**Imagen:** {'‚úÖ S√≠' if root_node and root_node.get('image_url') else '‚ùå No'}\n\n"
            f"**Vista previa del mensaje:**\n"
            f"_{message_preview}_"
        )

        keyboard = [
            [InlineKeyboardButton("üìù Editar Mensaje", callback_data=f"edit_welcome_message_{chat_id}")],
            [InlineKeyboardButton("üîò Gestionar Botones/Submen√∫s", callback_data=f"edit_welcome_buttons_{chat_id}")],
            [InlineKeyboardButton("üñºÔ∏è Configurar Imagen", callback_data=f"edit_welcome_image_{chat_id}")],
            [
                InlineKeyboardButton("üîÑ Siempre", callback_data=f"welcome_mode_{chat_id}_always"),
                InlineKeyboardButton("üë§ Solo nuevos", callback_data=f"welcome_mode_{chat_id}_new_only")
            ],
            [InlineKeyboardButton("üîÑ Cambiar Estado", callback_data=f"toggle_welcome_{chat_id}")],
            [InlineKeyboardButton("üß™ Probar Bienvenida", callback_data=f"test_welcome_{chat_id}")],
            [InlineKeyboardButton("üîô Volver", callback_data="manage_welcomes")]
        ]
        
        await self.safe_edit_message_text(
            query, 
            text, 
            reply_markup=InlineKeyboardMarkup(keyboard), 
            parse_mode=ParseMode.MARKDOWN
        )

    async def show_manage_welcomes(self, query):
        """Muestra gesti√≥n de bienvenidas"""
        groups = await self.db.get_all_active_groups()
        if not groups:
            await self.safe_edit_message_text(
                query,
                "üì≠ **No hay grupos para gestionar**\n\n"
                "A√±ade el bot a grupos para poder configurar sus bienvenidas.",
                reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("üîô Volver", callback_data="admin_panel")]])
            )
            return

        text = "üéâ **Gesti√≥n de Bienvenidas**\n\n"
        keyboard = []
        
        for group in groups:
            welcome_config = await self.db.get_welcome_settings(group[0])
            status = "‚úÖ" if welcome_config and welcome_config[1] else "‚ùå"
            text += f"{status} **{group[1]}**\n"
            
            keyboard.append([InlineKeyboardButton(
                f"{status} {truncate_text(group[1], 25)}",
                callback_data=f"config_welcome_{group[0]}"
            )])
            
        keyboard.append([InlineKeyboardButton("üîô Volver al Panel", callback_data="admin_panel")])
        
        await self.safe_edit_message_text(
            query, 
            text, 
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode=ParseMode.MARKDOWN
        )

    async def show_node_manager(self, query, chat_id: int, node_id: int | None):
        """Muestra el gestor de nodos/botones"""
        await self.db.ensure_root_node(chat_id)
        node = await self.db.get_root_node(chat_id) if node_id is None else await self.db.get_node(node_id)
        
        if not node:
            await self.safe_edit_message_text(query, "‚ùå Nodo no encontrado.")
            return

        buttons = self._buttons_to_list(node.get('buttons'))
        btn_count = sum(len(r) for r in buttons)
        pmode = self._normalize_parse_mode(node.get('parse_mode') or "HTML")

        node_label = "Ra√≠z (Principal)" if node['parent_id'] is None else f"Submen√∫ ID {node['id']}"
        
        text = f"üîò **Gestor de Botones y Submen√∫s**\n\n"
        text += f"**Nodo:** {node_label}\n"
        text += f"**Botones configurados:** {btn_count}\n"
        text += f"**Parse mode:** {pmode}\n"
        text += f"**Imagen:** {'‚úÖ S√≠' if node.get('image_url') else '‚ùå No'}\n\n"

        if buttons:
            text += "**Botones actuales:**\n"
            for i, row in enumerate(buttons, 1):
                for j, b in enumerate(row, 1):
                    if b.get('type') == 'url':
                        text += f"‚Ä¢ [{i}.{j}] üîó {b.get('text')} ‚Üí `{b.get('url')}`\n"
                    elif b.get('type') == 'node':
                        text += f"‚Ä¢ [{i}.{j}] üìÅ {b.get('text')} ‚Üí Submen√∫ {b.get('node_id')}\n"
        else:
            text += "_No hay botones configurados en este nodo._\n"

        children = await self.db.get_child_nodes(node['chat_id'], node['id'])
        if children:
            text += f"\n**Submen√∫s hijos:** {len(children)}\n"
            for ch in children[:3]:  # Mostrar solo los primeros 3
                preview = truncate_text(ch['text'] or '', 40)
                text += f"‚Ä¢ Submen√∫ {ch['id']}: _{preview}_\n"
            if len(children) > 3:
                text += f"‚Ä¢ ... y {len(children) - 3} m√°s\n"

        keyboard = [
            [
                InlineKeyboardButton("‚ûï Bot√≥n URL", callback_data=f"node_add_url_{node['id']}"),
                InlineKeyboardButton("‚ûï Submen√∫", callback_data=f"node_add_sub_{node['id']}")
            ],
            [
                InlineKeyboardButton("üìù Editar texto", callback_data=f"node_rename_{node['id']}"),
                InlineKeyboardButton("üñºÔ∏è Imagen", callback_data=f"node_set_image_{node['id']}")
            ],
            [InlineKeyboardButton(f"üõ† Parse: {pmode}", callback_data=f"node_parse_{node['id']}")],
            [InlineKeyboardButton("üßπ Limpiar botones", callback_data=f"node_clear_btns_{node['id']}")]
        ]
        
        if node['parent_id'] is not None:
            keyboard.append([InlineKeyboardButton("üóëÔ∏è Eliminar este submen√∫", callback_data=f"node_del_{node['id']}")])
            
        if children:
            keyboard.append([InlineKeyboardButton("üìÇ Ver submen√∫s", callback_data=f"node_list_children_{node['chat_id']}_{node['id']}")])
            
        keyboard.append([InlineKeyboardButton("üîô Volver", callback_data=f"config_welcome_{chat_id}")])

        await self.safe_edit_message_text(
            query, 
            text, 
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode=ParseMode.MARKDOWN
        )

    async def start_add_url_button(self, query, node_id: int):
        """Inicia proceso de a√±adir bot√≥n URL"""
        node = await self.db.get_node(node_id)
        self.message_handler.waiting_for_input[query.from_user.id] = {
            'action': 'button_text',
            'button_type': 'url',
            'node_id': node_id,
            'chat_id': node['chat_id']
        }
        
        await self.safe_edit_message_text(
            query,
            "üîò **A√±adir Bot√≥n URL**\n\n"
            "**Paso 1 de 2:** Env√≠a el texto que tendr√° el bot√≥n.\n\n"
            "Ejemplo: `Visitar sitio web`, `M√°s informaci√≥n`, etc.",
            reply_markup=InlineKeyboardMarkup([[
                InlineKeyboardButton("‚ùå Cancelar", callback_data=f"node_mgr_{node['chat_id']}_{node_id}")
            ]]),
            parse_mode=ParseMode.MARKDOWN
        )

    async def start_add_submenu_button(self, query, node_id: int):
        """Inicia proceso de a√±adir submen√∫"""
        node = await self.db.get_node(node_id)
        self.message_handler.waiting_for_input[query.from_user.id] = {
            'action': 'button_sub_text',
            'node_id': node_id,
            'chat_id': node['chat_id']
        }
        
        await self.safe_edit_message_text(
            query,
            "üìÅ **A√±adir Submen√∫**\n\n"
            "**Paso 1 de 2:** Env√≠a el texto del bot√≥n que abrir√° el submen√∫.\n\n"
            "Ejemplo: `Ver m√°s opciones`, `Informaci√≥n adicional`, etc.",
            reply_markup=InlineKeyboardMarkup([[
                InlineKeyboardButton("‚ùå Cancelar", callback_data=f"node_mgr_{node['chat_id']}_{node_id}")
            ]]),
            parse_mode=ParseMode.MARKDOWN
        )

    async def start_welcome_message_edit(self, query, chat_id: int):
        """Inicia edici√≥n del mensaje de bienvenida"""
        self.message_handler.waiting_for_input[query.from_user.id] = {
            'action': 'welcome_message',
            'chat_id': chat_id
        }
        
        text = (
            "üìù **Editar Mensaje de Bienvenida**\n\n"
            "Env√≠a el nuevo mensaje que se mostrar√° cuando alguien se una al grupo.\n\n"
            "**Variables disponibles:**\n"
            "‚Ä¢ `{mention}` ‚Äî menciona al usuario\n"
            "‚Ä¢ `{name}` ‚Äî nombre del usuario\n"
            "‚Ä¢ `{username}` ‚Äî @usuario o nombre si no tiene\n"
            "‚Ä¢ `{group_name}` ‚Äî nombre del grupo\n\n"
            "**Formatos soportados:**\n"
            "‚Ä¢ HTML: `<b>negrita</b>`, `<i>cursiva</i>`\n"
            "‚Ä¢ MarkdownV2: `**negrita**`, `*cursiva*`\n\n"
            "**Ejemplo:**\n"
            "`¬°Bienvenido/a {mention} a {group_name}! üéâ`"
        )
        
        await self.safe_edit_message_text(
            query,
            text,
            reply_markup=InlineKeyboardMarkup([[
                InlineKeyboardButton("‚ùå Cancelar", callback_data=f"config_welcome_{chat_id}")
            ]]),
            parse_mode=ParseMode.MARKDOWN
        )

    async def toggle_welcome_status(self, query, chat_id: int):
        """Cambia el estado de la bienvenida"""
        new_status = await self.db.toggle_welcome_status(chat_id)
        status_text = "activada" if new_status else "desactivada"
        await query.answer(f"‚úÖ Bienvenida {status_text}")
        await self.show_welcome_config(query, chat_id)

    async def show_bot_info(self, query):
        """Muestra informaci√≥n del bot"""
        stats = await self.db.get_general_stats()
        
        text = (
            "‚ÑπÔ∏è **Informaci√≥n del Bot**\n\n"
            f"**Nombre:** Bot Administrador de Grupos\n"
            f"**Versi√≥n:** 2.0.0\n"
            f"**Estado:** ‚úÖ Online\n\n"
            f"**Estad√≠sticas:**\n"
            f"‚Ä¢ Grupos activos: {stats['total_groups'][0]}\n"
            f"‚Ä¢ Bienvenidas enviadas: {stats['total_welcomes'][0] or 0}\n"
            f"‚Ä¢ Base de datos: MongoDB\n\n"
            f"**Funcionalidades:**\n"
            f"‚Ä¢ Sistema de bienvenida avanzado\n"
            f"‚Ä¢ Botones y submen√∫s interactivos\n"
            f"‚Ä¢ Soporte para im√°genes y formatos\n"
            f"‚Ä¢ Gesti√≥n completa de grupos\n"
            f"‚Ä¢ Configuraci√≥n de temas/hilos\n"
            f"‚Ä¢ Modos de bienvenida personalizables\n"
            f"‚Ä¢ Panel de administraci√≥n completo\n"
            f"‚Ä¢ Estad√≠sticas en tiempo real"
        )
        
        keyboard = [[InlineKeyboardButton("üîô Volver al Panel", callback_data="admin_panel")]]
        
        await self.safe_edit_message_text(
            query, 
            text, 
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode=ParseMode.MARKDOWN
        )

    async def show_group_settings(self, query, chat_id: int):
        """Muestra configuraciones de un grupo espec√≠fico"""
        # Actualizar informaci√≥n en vivo
        try:
            chat = await query.bot.get_chat(chat_id)
            member_count = await query.bot.get_chat_member_count(chat_id)
            is_forum_live = getattr(chat, "is_forum", False)
            await self.db.update_group_info(chat_id, chat.title, member_count, is_forum=is_forum_live)
        except Exception as e:
            logger.warning(f"‚ö†Ô∏è No se pudo actualizar info del grupo {chat_id}: {e}")

        group = await self.db.get_group_info(chat_id)
        if not group:
            await self.safe_edit_message_text(query, "‚ùå Grupo no encontrado.")
            return

        is_forum = bool(group[9])
        welcome_thread_id = group[10]

        text = (
            f"‚öôÔ∏è **Configuraciones del Grupo**\n\n"
            f"**Informaci√≥n b√°sica:**\n"
            f"‚Ä¢ Nombre: {group[1]}\n"
            f"‚Ä¢ ID: `{chat_id}`\n"
            f"‚Ä¢ Tipo: {group[2]}\n"
            f"‚Ä¢ Miembros: {group[6]}\n\n"
            f"**Configuraci√≥n:**\n"
            f"‚Ä¢ Temas habilitados: {'‚úÖ S√≠' if is_forum else '‚ùå No'}\n"
            f"‚Ä¢ Tema de bienvenidas: {welcome_thread_id if welcome_thread_id is not None else 'No configurado'}\n\n"
            f"**Historial:**\n"
            f"‚Ä¢ A√±adido por: {group[5]}\n"
            f"‚Ä¢ Fecha de adici√≥n: {format_date(group[7])}"
        )

        keyboard = [
            [InlineKeyboardButton("üéâ Configurar Bienvenida", callback_data=f"config_welcome_{chat_id}")],
            [InlineKeyboardButton("üìä Ver Estad√≠sticas", callback_data=f"group_stats_{chat_id}")],
            [InlineKeyboardButton("üßµ Configurar tema", callback_data=f"set_welcome_topic_instr_{chat_id}")],
            [InlineKeyboardButton("üîÑ Actualizar Info", callback_data=f"update_group_{chat_id}")],
            [InlineKeyboardButton("‚ùå Desactivar Grupo", callback_data=f"deactivate_group_{chat_id}")],
            [InlineKeyboardButton("üîô Volver", callback_data="view_groups")]
        ]
        
        await self.safe_edit_message_text(
            query, 
            text, 
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode=ParseMode.MARKDOWN
        )

    async def show_group_config(self, query, chat_id: int):
        """Alias para show_group_settings"""
        await self.show_group_settings(query, chat_id)

    async def show_group_stats(self, query, chat_id: int):
        """Muestra estad√≠sticas de un grupo"""
        group = await self.db.get_group_info(chat_id)
        stats = await self.db.get_group_stats(chat_id)
        
        if not group:
            await self.safe_edit_message_text(query, "‚ùå Grupo no encontrado.")
            return

        try:
            days_active = (datetime.utcnow() - datetime.fromisoformat(group[7])).days
        except:
            days_active = "N/D"

        welcomes_sent = stats[1] if stats else 0
        last_activity = format_date(stats[2]) if stats and stats[2] else "Nunca"

        text = (
            f"üìà **Estad√≠sticas del Grupo**\n\n"
            f"**{group[1]}**\n\n"
            f"**Actividad:**\n"
            f"‚Ä¢ D√≠as activo: {days_active}\n"
            f"‚Ä¢ Bienvenidas enviadas: {welcomes_sent}\n"
            f"‚Ä¢ √öltima actividad: {last_activity}\n\n"
            f"**Informaci√≥n actual:**\n"
            f"‚Ä¢ Miembros actuales: {group[6]}\n"
            f"‚Ä¢ Estado: {'‚úÖ Activo' if group[8] else '‚ùå Inactivo'}\n"
            f"‚Ä¢ Tipo de chat: {group[2]}"
        )

        keyboard = [
            [InlineKeyboardButton("üîÑ Actualizar", callback_data=f"refresh_stats_{chat_id}")],
            [InlineKeyboardButton("üîô Volver", callback_data=f"group_settings_{chat_id}")]
        ]
        
        await self.safe_edit_message_text(
            query, 
            text, 
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode=ParseMode.MARKDOWN
        )

    async def show_general_stats(self, query):
        """Muestra estad√≠sticas generales del bot"""
        stats = await self.db.get_general_stats()
        
        text = (
            "üìà **Estad√≠sticas Generales del Bot**\n\n"
            f"**Resumen:**\n"
            f"‚Ä¢ Grupos activos: {stats['total_groups'][0]}\n"
            f"‚Ä¢ Grupos inactivos: {stats['inactive_groups'][0]}\n"
            f"‚Ä¢ Total bienvenidas: {stats['total_welcomes'][0] or 0}\n"
            f"‚Ä¢ Promedio de miembros: {int(stats['avg_members'][0]) if stats['avg_members'][0] else 0}\n\n"
            f"**üèÜ Top 5 grupos (por bienvenidas):**\n"
        )
        
        for i, group in enumerate(stats['top_groups'], 1):
            text += f"{i}. {group[0]}: {group[1]} bienvenidas\n"
            
        if not stats['top_groups']:
            text += "_No hay datos de bienvenidas a√∫n._\n"

        keyboard = [
            [InlineKeyboardButton("üîÑ Actualizar", callback_data="general_stats")],
            [InlineKeyboardButton("üîô Volver", callback_data="admin_panel")]
        ]
        
        await self.safe_edit_message_text(
            query, 
            text, 
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode=ParseMode.MARKDOWN
        )

    async def show_global_settings(self, query):
        """Muestra configuraciones globales"""
        settings = await self.db.get_all_settings()
        language = settings.get('language', 'es')
        datefmt = settings.get('date_format', '%d/%m/%Y %H:%M')
        parse_mode = settings.get('default_parse_mode', 'HTML')

        text = (
            "‚öôÔ∏è **Configuraciones Globales**\n\n"
            f"**Configuraci√≥n actual:**\n"
            f"‚Ä¢ Idioma: {language.upper()}\n"
            f"‚Ä¢ Formato de fecha: `{datefmt}`\n"
            f"‚Ä¢ Parse Mode por defecto: {parse_mode}\n\n"
            "Selecciona una opci√≥n para modificar:"
        )
        
        keyboard = [
            [
                InlineKeyboardButton("üåê ES", callback_data="gs_lang_es"),
                InlineKeyboardButton("EN", callback_data="gs_lang_en"),
            ],
            [
                InlineKeyboardButton("üìÖ DD/MM/YYYY HH:mm", callback_data="gs_datefmt_1"),
                InlineKeyboardButton("YYYY-MM-DD HH:mm", callback_data="gs_datefmt_2"),
                InlineKeyboardButton("DD/MM/YYYY", callback_data="gs_datefmt_3"),
            ],
            [
                InlineKeyboardButton("üìù HTML", callback_data="gs_parse_HTML"),
                InlineKeyboardButton("MarkdownV2", callback_data="gs_parse_MarkdownV2"),
            ],
            [InlineKeyboardButton("üîô Volver", callback_data="admin_panel")]
        ]
        
        await self.safe_edit_message_text(
            query, 
            text, 
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode=ParseMode.MARKDOWN
        )

    async def handle_back_navigation(self, query, data: str):
        """Maneja navegaci√≥n hacia atr√°s"""
        parts = data.split("_")
        destination = parts[1] if len(parts) > 1 else ""
        
        if destination == "admin":
            await self.show_admin_panel(query)
        elif destination == "groups":
            await self.show_groups_list(query)
        elif destination == "welcomes":
            await self.show_manage_welcomes(query)
        else:
            # Navegaci√≥n por defecto
            await self.show_admin_panel(query)
